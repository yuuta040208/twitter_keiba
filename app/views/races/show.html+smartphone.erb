<h4>
  <%= link_to @race.name, 'https://race.netkeiba.com' + @race.url, target: '_blank'%>
  <small><%= @race.hold %> <%= @race.number %></small>
</h4>

<p class="small-text"><%= link_to 'ホームに戻る', root_path %></p>

<div class="form-inline">
  <%= form_tag(race_path(params[:id]), method: 'get') do %>
    <%= text_field_tag :search, params[:search], class: 'form-control sm-3' %>
    <%= submit_tag '検索', name: nil, class: 'btn btn-primary sm-2' %>
  <% end %>
</div>

<br>

<%= paginate @forecasts, window: 1 %>

<table class="table table-bordered table-striped table-sm text-table">
  <thead>
  <tr class="fixed-header">
    <th class="sticky" style="background-color: darkgrey; width: 15%;"></th>
    <% count = @horses.count %>
    <% @horses.order(:umaban).each_with_index.reverse_each do |horse, i| %>
      <% index = Settings[:index][count][i] %>
      <% background_color = Settings[:color][index] %>
      <% text_color = background_color == 'black' || background_color == 'red' || background_color == 'blue' ? 'white' : 'black' %>

      <th class="horse sticky" style="background-color: <%= background_color %>; color: <%= text_color %>; padding: 0;">
        <span class="vertical">
          <span class="text-combine"><%= horse.umaban %></span>
          <%= horse.name %>
        </span>
      </th>
    <% end %>
  </tr>

  </thead>

  <tr>
    <th>オッズ</th>
    <% @horses.reverse_each do |horse| %>
      <td align="center"><span class="vertical"><%= horse.odds %></span></td>
    <% end %>
  </tr>

  <tr>
    <th>◎ の個数</th>
    <% honmeis = @race.forecasts.pluck(:honmei) %>
    <% @horses.reverse_each do |horse| %>
      <td align="center"><%= honmeis.count(horse.name) %></td>
    <% end %>
  </tr>

  <tr>
    <th>○ の個数</th>
    <% taikous = @race.forecasts.pluck(:taikou) %>
    <% @horses.reverse_each do |horse| %>
      <td align="center"><%= taikous.count(horse.name) %></td>
    <% end %>
  </tr>

  <tr>
    <th>▲ の個数</th>
    <% tananas = @race.forecasts.pluck(:tanana) %>
    <% @horses.reverse_each do |horse| %>
      <td align="center"><%= tananas.count(horse.name) %></td>
    <% end %>
  </tr>

  <tr>
    <th>△ の個数</th>
    <% renkas = @race.forecasts.pluck(:renka) %>
    <% @horses.reverse_each do |horse| %>
      <td align="center"><%= renkas.count(horse.name) %></td>
    <% end %>
  </tr>

  <tr>
    <td></td>
  </tr>

  <tbody>

  <% @forecasts.each do |forecast| %>
    <tr>
      <th align="left">
        <%= link_to "#{forecast.user.name} (#{forecast.user.point})", user_path(forecast.user.id) %>
        <%= link_to forecast.tweet.url, target: '_blank' do %>
          <%= image_tag asset_path('twitter_icon.png') %>
        <% end %>
      </th>
      <% @horses.reverse_each do |horse| %>
        <% mark = '' %>
        <% if forecast.honmei == horse.name %>
          <% mark = '◎' %>
        <% elsif forecast.taikou == horse.name %>
          <% mark = '◯' %>
        <% elsif forecast.tanana == horse.name %>
          <% mark = '▲' %>
        <% elsif forecast.renka == horse.name %>
          <% mark = '△' %>
        <% end %>
        <td align="center"><%= mark %></td>
      <% end %>
    </tr>
  <% end %>
  </tbody>
</table>

<%= paginate @forecasts, window: 1 %>
